---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { stat } from 'node:fs/promises';
import { join } from 'node:path';

const plans = await getCollection('plans');

// Get file modified times AND headings
const plansWithMetadata = await Promise.all(
  plans.map(async (plan) => {
    // Get file stats
    const filePath = join(process.env.MARKDOWN_PLANS_PATH || '', `${plan.id}.md`);
    let modifiedTime = new Date(0);
    try {
      const stats = await stat(filePath);
      modifiedTime = stats.mtime;
    } catch (err) {
      console.error(`Failed to get stats for ${plan.id}:`, err);
    }

    // Get headings
    const { headings } = await render(plan);
    const h1Headings = headings.filter(h => h.depth === 1);

    return {
      ...plan,
      modifiedTime,
      h1Headings
    };
  })
);

// Sort by modified time (newest first)
const sortedPlans = plansWithMetadata.sort((a, b) =>
  b.modifiedTime.getTime() - a.modifiedTime.getTime()
);

// Format date/time helper
function formatDateTime(date: Date): string {
  return new Intl.DateTimeFormat('en-GB', {
    dateStyle: 'medium',
    timeStyle: 'short'
  }).format(date);
}
---

<BaseLayout title="Project Plans" bodyClass="bg-gray-50">
  <h1 class="text-3xl font-bold mb-8">Project Plans</h1>

  <div class="bg-white shadow rounded-lg overflow-hidden">
    <table class="w-full">
      <thead class="bg-slate-50 border-b border-slate-200">
        <tr>
          <th class="text-left px-2 py-1 font-semibold text-slate-700">Plan</th>
          <th class="text-left px-2 py-1 font-semibold text-slate-700">Last Modified</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        {sortedPlans.map(plan => (
          <tr class="hover:bg-blue-50 transition">
            <td class="px-2 py-1">
              <a href={`/${plan.id}`} class="text-lg font-medium text-blue-600 hover:underline block mb-2">
                {plan.id}
              </a>
              {plan.h1Headings.length > 0 && (
                <ul class="text-sm text-slate-600 space-y-1">
                  {plan.h1Headings.map(heading => (
                    <li class="flex items-start">
                      <span class="mr-2">â€¢</span>
                      <span>{heading.text}</span>
                    </li>
                  ))}
                </ul>
              )}
            </td>
            <td class="px-2 py-1 text-slate-600 align-top">
              {formatDateTime(plan.modifiedTime)}
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</BaseLayout>